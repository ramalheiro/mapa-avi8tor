<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>Mapa Avançado de Voos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.js"></script>
<style>
  body, html { margin:0; padding:0; height:100%; }
  #map { width:100%; height:100%; }
  .label {
    background: rgba(0,0,0,0.6);
    color: #fff;
    padding: 3px 6px;
    border-radius: 6px;
    font-size: 12px;
    font-family: sans-serif;
    white-space: nowrap;
  }
</style>
</head>
<body>
<div id="map"></div>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoicmFtYWxoZWlybyIsImEiOiJjbWZtdmN4OTcwNmM3Mm1vbDhtY3UxZ2ViIn0.7xL1bz2EaA_L5CHtBb9Ruw';

const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/light-v11',
  center: [-47.9, -15.8],
  zoom: 4
});

function parseFlights() {
  const params = new URLSearchParams(window.location.search);
  const flightsStr = params.get("flights");
  if (!flightsStr) return { features: [], endpoints: [] };

  const legs = flightsStr.split(";").map(l => l.trim()).filter(Boolean);
  const features = [];
  const endpoints = [];

  legs.forEach((leg, idx) => {
    const parts = leg.split(",").map(p => p.trim());
    if (parts.length < 10) { console.warn("Pernas inválidas:", leg); return; }

    const [origICAO, origLatStr, origLonStr, origCity,
           destICAO, destLatStr, destLonStr, destCity,
           distanceKM, timeHHMM, colorRaw] = parts;

    const oLat = parseFloat(origLatStr), oLon = parseFloat(origLonStr);
    const dLat = parseFloat(destLatStr), dLon = parseFloat(destLonStr);
    if ([oLat,oLon,dLat,dLon].some(v => isNaN(v))) { console.warn("Coordenadas inválidas:", leg); return; }

    const color = (colorRaw && colorRaw.trim() !== '') ? colorRaw.trim() : "#222222";

    // Linha do voo
    features.push({
      type: "Feature",
      geometry: { type: "LineString", coordinates: [[oLon,oLat],[dLon,dLat]] },
      properties: {
        color,
        label: `${idx+1}. ${origCity} → ${destCity}\n${distanceKM} km | ${timeHHMM}`,
        mid: [(oLon+dLon)/2, (oLat+dLat)/2]
      }
    });

    // Pontos nas extremidades
    endpoints.push({ type:'Feature', geometry:{type:'Point', coordinates:[oLon,oLat]}, properties:{color} });
    endpoints.push({ type:'Feature', geometry:{type:'Point', coordinates:[dLon,dLat]}, properties:{color} });
  });

  return { features, endpoints };
}

const { features: flightFeatures, endpoints } = parseFlights();

map.on("load", () => {
  if (!flightFeatures.length) { console.log("Nenhuma perna encontrada."); return; }

  // Linhas
  map.addSource("flights", { type:'geojson', data:{ type:'FeatureCollection', features:flightFeatures } });
  map.addLayer({
    id:'flight-lines',
    type:'line',
    source:'flights',
    layout:{ 'line-join':'round','line-cap':'round' },
    paint:{ 'line-color':['get','color'], 'line-width':2 }
  });

  // Pontos nas extremidades
  map.addSource('endpoints', { type:'geojson', data:{ type:'FeatureCollection', features:endpoints } });
  map.addLayer({
    id:'endpoints-layer',
    type:'circle',
    source:'endpoints',
    paint:{
      'circle-radius':5,
      'circle-color':['get','color'],
      'circle-stroke-color':'#fff',
      'circle-stroke-width':1
    }
  });

  // Labels no ponto médio
  flightFeatures.forEach(f => {
    const el = document.createElement("div");
    el.className = "label";
    el.innerText = f.properties.label;

    new mapboxgl.Marker({ element: el, anchor:"center" })
      .setLngLat(f.properties.mid)
      .addTo(map);
  });

  // Zoom automático
  const coords = flightFeatures.flatMap(f => f.geometry.coordinates);
  const bounds = coords.reduce((b,c)=>b.extend(c), new mapboxgl.LngLatBounds(coords[0],coords[0]));
  map.fitBounds(bounds,{padding:60});
});
</script>
</body>
</html>
